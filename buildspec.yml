version: 0.2

phases:
  install:
    runtime-versions:
      java: corretto17
      nodejs: 18
    commands:
      - |
        echo "[install] runtime check"
        java -version
        node -v
        npm -v

  build:
    commands:
      - |
        echo "[build] repo root"
        if [ -d "book_management" ]; then cd book_management; fi
        WORKDIR="$(pwd)"
        echo "WORKDIR=${WORKDIR}"
        ls -la

        echo "[build] detect backend dir (gradlew/build.gradle/pom.xml)"
        BACKEND_DIR="$(dirname "$(find . -maxdepth 6 -type f -name gradlew -print -quit)")"
        if [ -z "${BACKEND_DIR}" ] || [ "${BACKEND_DIR}" = "." ]; then
          BACKEND_DIR="$(dirname "$(find . -maxdepth 6 -type f -name build.gradle -print -quit)")"
        fi
        if [ -z "${BACKEND_DIR}" ] || [ "${BACKEND_DIR}" = "." ]; then
          BACKEND_DIR="$(dirname "$(find . -maxdepth 6 -type f -name pom.xml -print -quit)")"
        fi
        echo "BACKEND_DIR=${BACKEND_DIR}"

        if [ -z "${BACKEND_DIR}" ] || [ ! -d "${WORKDIR}/${BACKEND_DIR}" ]; then
          echo "ERROR: backend directory not found"
          exit 2
        fi

        echo "[build] backend build"
        cd "${WORKDIR}/${BACKEND_DIR}"
        ls -la

        if [ -f "./gradlew" ]; then
          echo "Use Gradle Wrapper"
          chmod +x ./gradlew
          ./gradlew --no-daemon clean test build
        elif command -v gradle >/dev/null 2>&1; then
          echo "Use system gradle"
          gradle clean test build
        elif [ -f "./mvnw" ]; then
          echo "Use Maven Wrapper"
          chmod +x ./mvnw
          ./mvnw -B test package
        elif command -v mvn >/dev/null 2>&1; then
          echo "Use system mvn"
          mvn -B test package
        else
          echo "ERROR: no gradle/maven tool found. Add wrapper to repo."
          exit 3
        fi

        echo "[build] detect frontend dir (package.json)"
        cd "${WORKDIR}"
        FRONTEND_DIR="$(dirname "$(find . -maxdepth 6 -type f -name package.json -not -path '*/node_modules/*' -print -quit)")"
        echo "FRONTEND_DIR=${FRONTEND_DIR}"

        if [ -z "${FRONTEND_DIR}" ] || [ ! -d "${WORKDIR}/${FRONTEND_DIR}" ]; then
          echo "ERROR: frontend directory not found"
          exit 4
        fi

        echo "[build] frontend build"
        cd "${WORKDIR}/${FRONTEND_DIR}"
        npm ci
        npm run build

        echo "[build] collect artifacts"
        cd "${WORKDIR}"
        mkdir -p artifact/backend artifact/frontend

        echo "[build] search backend jar/war (optional)"
        BACK_ART_PATH="$(find "${WORKDIR}/${BACKEND_DIR}" -maxdepth 10 -type f \( -name "*.jar" -o -name "*.war" \) \
          -not -path "*/.gradle/*" -not -path "*/gradle/wrapper/*" -print -quit)"
        echo "BACK_ART_PATH=${BACK_ART_PATH}"

        if [ -n "${BACK_ART_PATH}" ]; then
          cp "${BACK_ART_PATH}" artifact/backend/
          echo "[build] backend artifact copied"
        else
          echo "[warn] backend jar/war not found. Copying build outputs (build/ or target/) instead."
          if [ -d "${WORKDIR}/${BACKEND_DIR}/build" ]; then
            mkdir -p artifact/backend/build_output
            cp -r "${WORKDIR}/${BACKEND_DIR}/build" artifact/backend/build_output/
          fi
          if [ -d "${WORKDIR}/${BACKEND_DIR}/target" ]; then
            mkdir -p artifact/backend/build_output
            cp -r "${WORKDIR}/${BACKEND_DIR}/target" artifact/backend/build_output/
          fi
        fi

        echo "[build] frontend output copy (dist/build)"
        cd "${WORKDIR}"
        if [ -d "${WORKDIR}/${FRONTEND_DIR}/dist" ]; then
          cp -r "${WORKDIR}/${FRONTEND_DIR}/dist" artifact/frontend/
        elif [ -d "${WORKDIR}/${FRONTEND_DIR}/build" ]; then
          cp -r "${WORKDIR}/${FRONTEND_DIR}/build" artifact/frontend/
        else
          echo "ERROR: frontend output dir not found (dist/build)"
          ls -la "${WORKDIR}/${FRONTEND_DIR}" || true
          exit 6
        fi

        echo "COMMIT=${CODEBUILD_RESOLVED_SOURCE_VERSION}" > artifact/BUILD_INFO.txt
        echo "BACKEND_DIR=${BACKEND_DIR}" >> artifact/BUILD_INFO.txt
        echo "FRONTEND_DIR=${FRONTEND_DIR}" >> artifact/BUILD_INFO.txt

artifacts:
  files:
    - artifact/**/*
  discard-paths: no
